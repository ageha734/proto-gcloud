name: '[Release] Proto Tools'

permissions:
    contents: write

on:
    push:
        tags:
        - 'v[0-9]+*'

jobs:
    build:
        runs-on: ubuntu-24.04

        outputs:
            changelog_entry: ${{ steps.build.outputs.changelog_entry }}

        steps:
        - name: Checkout Repository
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

        - name: Setup Rust
          uses: moonrepo/setup-rust@ede6de059f8046a5e236c94046823e2af11ca670 # v1.2.2
          with:
              channel: '1.90.0'
              targets: wasm32-wasip1
              cache-targets: release
              cache: false

        - id: build
          name: Build Proto Plugin
          uses: moonrepo/build-wasm-plugin@60ff6f68ae0e0b4dc4b959835cd84b8d535403c2 # v0.4.2

        - name: Upload Build Artifacts
          uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
          with:
              name: proto-plugin-artifacts
              path: builds/*
              retention-days: 1

    release:
        needs: build

        runs-on: ubuntu-24.04

        steps:
        - name: Download Build Artifacts
          uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
          with:
              name: proto-plugin-artifacts
              path: builds

        - name: Release
          uses: ncipollo/release-action@bcfe5470707e8832e12347755757cec0eb3c22af # v1.18.0
          with:
              artifacts: builds/*
              artifactErrorsFailBuild: true
              body: ${{ steps.build.outputs.changelog_entry }}
              makeLatest: true
              prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
              skipIfReleaseExists: true

    rerun-on-failure:
        needs: release

        if: failure() && fromJSON(github.run_attempt) < 3
        runs-on: ubuntu-24.04

        steps:
        - run: gh workflow run rerun.yml -F run_id=${{ github.run_id }}
          env:
              GH_REPO: ${{ github.repository }}
              GH_TOKEN: ${{ github.token }}
              GH_DEBUG: api

    update-changelog:
        needs: release

        runs-on: ubuntu-24.04

        steps:
        - name: Checkout Repository
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
          with:
              ref: ${{ github.event.repository.default_branch }}

        - name: Update CHANGELOG
          run: |
              VERSION=${GITHUB_REF_NAME#v}

              if [ ! -f "CHANGELOG.md" ]; then
                  echo "CHANGELOG.md not found. Creating it..."
                  cat > CHANGELOG.md << EOF
              # Changelog

              ## $VERSION

              Release notes: https://github.com/${{ github.repository }}/releases/tag/${GITHUB_REF_NAME}
              EOF
              else
                  if grep -q "Unreleased" CHANGELOG.md; then
                      sed -i "s/Unreleased/$VERSION/" CHANGELOG.md
                  else
                      sed -i "/# Changelog/a\\\n## $VERSION\n\nRelease notes: https://github.com/${{ github.repository }}/releases/tag/${GITHUB_REF_NAME}\n" CHANGELOG.md
                  fi
              fi

              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

              if git diff --quiet CHANGELOG.md; then
                  echo "No changes to CHANGELOG.md"
              else
                  git add CHANGELOG.md
                  git commit -m "docs: update CHANGELOG for $VERSION [skip ci]"
                  git push origin HEAD:${{ github.event.repository.default_branch }}
                  echo "CHANGELOG.md updated and pushed"
              fi
